<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WooParts & AutoApex â€” Sales Report/Order Generator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    :root{--bg: #f6f8fb; --panel:#fff; --panel-2:#fcfdff; --text:#0f172a; --muted:#445268;--brand:#2563eb; --brand-2:#06b6d4; --border:#dbe2ea; --ring: rgba(37,99,235,.25);--chip-bg:#f8fafc; --chip-border:#e2e8f0; --input-bg:#fff; --input-border:#cbd5e1; --input-text:#0f172a;--table-alt:#f1f5f9; --table-hover:#eef6ff; --button-text:#fff;}
    :root[data-theme="dark"]{--bg:#0b1220; --panel:#0f172a; --panel-2:#0b1224; --text:#e6edf3; --muted:#9fb1c7;--brand:#60a5fa; --brand-2:#22d3ee; --border:#1f2a3a; --ring:rgba(110,231,255,.35);--chip-bg:#0f172a; --chip-border:#1f2a3a; --input-bg:#0b1220; --input-border:#233048; --input-text:#e6edf3;--table-alt: rgba(255,255,255,.02); --table-hover: rgba(96,165,250,.07); --button-text:#0b1220;}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui; padding:14px}
    .shell{width:100%}
    .header,.controls{background:linear-gradient(180deg,var(--panel),var(--panel-2)); border:1px solid var(--border); border-radius:12px; padding:12px; margin-bottom:12px}
    .controls{position:sticky;top:8px;z-index:10}
    h1{margin:0;font-size:20px}
    .left-controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .right-tools{display:flex;gap:8px;align-items:center;justify-content:flex-end}
    input[type="file"],.top-input{padding:8px;border:1px solid var(--input-border);background:var(--input-bg);color:var(--input-text);border-radius:10px;min-width:240px}
    button{padding:9px 12px;border:0;border-radius:10px;background:linear-gradient(180deg, var(--brand), var(--brand-2));color:var(--button-text);font-weight:600;cursor:pointer}
    .pill{padding:6px 10px;border:1px solid var(--input-border);border-radius:999px;background:var(--input-bg);color:#445268;font-size:12px;cursor:pointer}
    .pill.active{outline:3px solid var(--ring)}
    #meta{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px}
    .chip{font-size:12px;border:1px solid var(--chip-border);background:var(--chip-bg);border-radius:999px;padding:6px 10px;color:#475569}
    .table-wrap{ width:100%; height:72vh; overflow:auto;border:1px solid var(--border); border-radius:12px;background:linear-gradient(180deg,var(--panel),var(--panel-2)); box-shadow:0 6px 18px rgba(0,0,0,.12); }
    table{width:100%; border-collapse:separate; border-spacing:0}
    thead th{ position:sticky; top:0; z-index:5; background:var(--panel); color:var(--text);
      text-align:left; padding:10px 12px; font-weight:600; font-size:12px; letter-spacing:.2px; border-bottom:1px solid var(--border); white-space:nowrap; }
    tbody td{ padding:9px 12px; border-bottom:1px solid var(--border); font-size:13px; color:var(--text) }
    tbody tr:nth-child(odd) td{ background:var(--table-alt) }
    tbody tr:hover td{ background:var(--table-hover) }
    .po-edit,.cf-edit{width: 220px; max-width: 100%; padding: 6px 8px;border:1px solid var(--input-border); border-radius:8px; background:var(--input-bg); color:var(--input-text);}
    .hidden{display:none}
    .author {margin: 4px 0 0 0;font-size: 13px;color: var(--muted);font-style: italic;}
  </style>

<style id="kp360-empty-highlights">
/* === KP360: Empty-cell highlighting === */
td.kp-hl-red { background: #fde2e1 !important; }      /* Light Red */
td.kp-hl-yellow { background: #fef3c7 !important; }   /* Light Yellow */
td.kp-hl-red input, td.kp-hl-yellow input { background-color: inherit !important; }
</style>

<style id="kp360-service-col-style">
/* === KP360: widen Service/Carrier column === */
th.kp-service-col, td.kp-service-col {min-width: 120px !important;width: 120px !important;white-space: normal;word-break: break-word;}</style>

<style id="kp360-row-warning-style">tr.kp-row-warn > td { background: #fde2e1 !important;}</style>

<style id="kp360-tip-bubble-style">
/* === KP360: Tip bubble for highlights === */
.kp-tip {position: fixed;z-index: 999999;max-width: 320px;padding: 8px 10px;border-radius: 6px;background: #111;color: #fff;font-size: 12px;line-height: 1.35;box-shadow: 0 6px 18px rgba(0,0,0,.25);pointer-events: none;opacity: 0;transform: translateY(-4px);transition: opacity .12s ease, transform .12s ease;white-space: normal;word-break: break-word;}
.kp-tip.show { opacity: 0.96; transform: translateY(0); }
.kp-tip strong { font-weight: 600; }
.kp-tip .kp-tip-head { display: block; margin-bottom: 4px; font-weight: 600; color: #fef3c7; } /* light yellow title */
.kp-tip .kp-tip-rule { color: #cbd5e1; }
td.kp-hl-red, td.kp-hl-yellow, tr.kp-row-warn > td { position: relative; }
</style>
</head>
<body>
  <div class="shell">
    <div class="header" style="display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center">
  <div>
    <h1>WooParts &amp; AutoApex â€” Sales Report/Order Generator</h1>
    <p class="author">by Christine Anastacio</p>
  </div>
  <div class="right-tools"><button id="themeToggle">ðŸŒ—</button></div>
</div>

    <div class="controls" style="display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center">
      <div class="left-controls">
        <input type="file" id="fileInput" multiple accept=".xlsx, .xls, .csv" />
        <button class="secondary" onclick="resetAll()">Reset</button>
        <div class="view-toggle" style="display:flex;gap:6px">
          <span id="pillReport" class="pill active" onclick="switchView('report')">Sales Report</span>
          <span id="pillOrder" class="pill" onclick="switchView('order')">Sales Order</span>
        </div>
      </div>
      <div class="right-tools">
        <label for="exportFilename">Export as</label>
        <input type="text" id="exportFilename" class="top-input" placeholder="File name" value="Sales_Report" />
        <button onclick="exportCurrent()">Export Current View</button>
      </div>
    </div>

    <div id="meta">
      <div id="totalOrders" class="chip">Total Orders: 0</div>
      <div id="ordersByDate" class="chip">Orders by Date:</div>
    </div>

    <div class="table-wrap" id="reportWrap">
      <table id="reportTable">
        <thead>
          <tr>
            <th>Order Date</th><th>Ship From</th><th>Order Number</th><th>Item SKU</th><th>Quantity</th>
            <th>Custom Field 1</th><th>Custom Field 2</th><th>Custom Field 3</th><th>Order Total</th>
            <th>Recipient</th><th>Rate</th><th>Service</th><th>Tracking Number</th><th>PO Number</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div style="height:10px"></div>

    <div class="table-wrap hidden" id="orderWrap">
      <table id="orderTable">
        <thead>
          <tr>
            <th>Order Date</th><th>Ship From</th><th>Order Number</th><th>Item SKU</th><th>Quantity</th>
            <th>Custom Field 1</th><th>Custom Field 2</th><th>Custom Field 3</th><th>Order Total</th>
            <th>Recipient</th><th>Carrier Fee</th><th>Service</th><th>Tracking Number</th><th>PO Reference Number</th><th>Memo</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    // theme toggle
    const htmlEl = document.documentElement;
    const savedTheme = localStorage.getItem('kp360_theme_v1');
    if(savedTheme){ htmlEl.setAttribute('data-theme', savedTheme); }
    document.getElementById('themeToggle').addEventListener('click', () => {
      const next = htmlEl.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
      htmlEl.setAttribute('data-theme', next);
      localStorage.setItem('kp360_theme_v1', next);
    });

    // === Original app JS with PO & CF edits wired to the data model ===
    let masterDataRows = [];
    let masterOrderNumbers = new Set();
    let isFirstFile = true;
    let updateFilesCount = 0;
    let currentView = 'report'; // 'report' | 'order'
    document.getElementById('fileInput').addEventListener('change', handleFiles);

    function switchView(view){
      currentView = view;
      document.getElementById('pillReport').classList.toggle('active', view==='report');
      document.getElementById('pillOrder').classList.toggle('active', view==='order');
      document.getElementById('reportWrap').classList.toggle('hidden', view!=='report');
      document.getElementById('orderWrap').classList.toggle('hidden', view!=='order');
      document.getElementById('reportTable').classList.toggle('hidden', view!=='report');
      document.getElementById('orderTable').classList.toggle('hidden', view!=='order');
      if(view==='order'){
        document.getElementById('exportFilename').value = 'Sales_Order';
        renderSalesOrder();
      } else {
        document.getElementById('exportFilename').value = 'Sales_Report';
        renderReport();
      }
    }

    function skuHasFBA(sku) { return ((sku || '') + '').toUpperCase().includes('FBA'); }
    function containsCodeAlphaBoundary(str, token) {
      const s = (str || '').toUpperCase();
      const t = token.toUpperCase().replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');
      const re = new RegExp(`(^|[^A-Z])${t}([^A-Z]|$)`);
      return re.test(s);
    }
    function computeShipFrom(row) {
      const po = ((row["PO Number"] || '') + '').toUpperCase();
      const skuRaw = row["Item SKU"] != null ? row["Item SKU"] : row["SKU"];
      const sku = ((skuRaw || '') + '').toUpperCase();
      if (po) {
        if (po.includes('CALIFORNIA') || containsCodeAlphaBoundary(po, 'CALI') || containsCodeAlphaBoundary(po, 'CA')) return 'California Distribution Warehouse';
        if (po.includes('GEORGIA') || containsCodeAlphaBoundary(po, 'GA')) return 'Georgia Distribution Warehouse';
        if (containsCodeAlphaBoundary(po, 'NJ')) return 'New Jersey Distribution Warehouse';
        if (containsCodeAlphaBoundary(po, 'IL')) return 'Chicago Distribution Warehouse';
      }
      if (sku.includes('FBA')) return 'FBA Warehouse';
      if (sku.includes('USA')) return 'Usauto Dropship';
      if (sku.includes('MLX')) return 'Meyer Dropship';
      if (sku.includes('OLX')) return 'Tonsa Dropship';
      return '';
    }
    function formatDate(dateValue) {
      if (typeof dateValue === 'number') {
        const d = XLSX.SSF.parse_date_code(dateValue);
        if (d) return `${d.m}/${d.d}/${d.y}`;
      }
      const dt = new Date(dateValue); if (isNaN(dt)) return dateValue;
      return `${dt.getMonth()+1}/${dt.getDate()}/${dt.getFullYear()}`;
    }
    function handleFiles(event) {
      const files = Array.from(event.target.files);
      files.forEach((file, fileIdx) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          let json = [];
          if (file.name.endsWith('.csv')) { const wb = XLSX.read(e.target.result, {type:'string'}); json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); }
          else { const wb = XLSX.read(e.target.result, {type:'binary'}); json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); }
          if (isFirstFile) {
            masterDataRows = []; masterOrderNumbers.clear();
            json.forEach(row => {
              const ord = row["Order Number"]||row["Site Order ID"]||row["Order #"]; if (!ord) return;
              const rec = (row["Recipient"]||`${row["Shipping First Name"]||''} ${row["Shipping Last Name"]||''}`).trim();
              const itemSku = row["Item SKU"]||row["SKU"]||'';
              const computedShipFrom = computeShipFrom(row);
              let cf1 = row["Custom Field 1"]||''; if (skuHasFBA(itemSku)) cf1 = itemSku;
              masterDataRows.push({
                "Order Date": formatDate(row["Order Date"]||''),
                "Ship From": computedShipFrom,
                "Order Number": ord,
                "Item SKU": itemSku,
                "Quantity": row["Quantity"]||'',
                "Custom Field 1": cf1,
                "Custom Field 2": row["Custom Field 2"]||'',
                "Custom Field 3": row["Custom Field 3"]||'',
                "Order Total": row["Order Total"]||'',
                "Recipient": rec,
                "Rate": row["Rate"]||'',
                "Service": (row["Service"]||'').replace(/Â®/g,''),
                "Tracking Number": row["Tracking Number"]||'',
                "PO Number": row["PO Number"]||''
              });
              masterOrderNumbers.add(ord);
            });
            isFirstFile = false;
          } else {
            const updates = new Map();
            json.forEach(r => {
              const ord = r["Order Number"]||r["Site Order ID"]||r["Order #"];
              if (!ord || !masterOrderNumbers.has(ord)) return;
              if (!updates.has(ord)) updates.set(ord, []);
              updates.get(ord).push(r);
            });
            updates.forEach((rows, ord) => {
              let idx = 0;
              for (let i = 0; i < masterDataRows.length && idx < rows.length; i++) {
                if (masterDataRows[i]["Order Number"] === ord) {
                  const u = rows[idx++];
                  for (const k in u) {
                    if ((!masterDataRows[i][k] || masterDataRows[i][k] === '') && u[k] !== undefined && u[k] !== '') {
                      masterDataRows[i][k] = u[k];
                    }
                  }
                }
              }
            });
            masterDataRows = masterDataRows.map(r => {
              const updated = { ...r };
              updated["Ship From"] = computeShipFrom(updated);
              if (skuHasFBA(r["Item SKU"])) updated["Custom Field 1"] = r["Item SKU"];
              return updated;
            });
            updateFilesCount++;
          }
          if(currentView==='order') renderSalesOrder();
          else renderReport();
        };
        if (file.name.endsWith('.csv')) reader.readAsText(file);
        else reader.readAsBinaryString(file);
      });
    }

    function renderReport(filteredData = null) {
      const tbody = document.getElementById('reportTable').querySelector('tbody');
      tbody.innerHTML = '';
      const rows = filteredData || masterDataRows;
      document.getElementById('totalOrders').textContent = `Total Orders: ${rows.length}`;
      const counts = {};
      rows.forEach(r => { counts[r["Order Date"]] = (counts[r["Order Date"]] || 0) + 1; });
      const parts = Object.entries(counts).map(([d,c]) => `${d}: ${c}`);
      document.getElementById('ordersByDate').textContent = `Orders by Date: ${parts.join('    |    ')}`;

      rows.forEach((row, idx) => tbody.appendChild(buildReportRowTr(row, idx)));
    }

    // Build Report Row (PO Number + Custom Fields editable)
    function buildReportRowTr(row, idx){
      const tr = document.createElement('tr');
      const keys = ["Order Date","Ship From","Order Number","Item SKU","Quantity","Custom Field 1","Custom Field 2","Custom Field 3","Order Total","Recipient","Rate","Service","Tracking Number","PO Number"];
      keys.forEach(key => {
        const td = document.createElement('td');

        if (key === "Service") {
          td.textContent = (row[key] || '').toString().replace(/Â®/g,'');
        } else if (key === "PO Number") {
          const input = document.createElement('input');
          input.type = 'text';
          input.className = 'po-edit';
          input.value = row["PO Number"] || '';
          input.placeholder = 'Enter PO Number';
          input.addEventListener('change', (e) => {
            const newPO = e.target.value;
            masterDataRows[idx]["PO Number"] = newPO;
            // Recompute Ship From for this row
            masterDataRows[idx]["Ship From"] = computeShipFrom(masterDataRows[idx]);
            // Update UI cells for Ship From
            const shipFromCell = tr.children[1]; // index 1 is "Ship From"
            if (shipFromCell) shipFromCell.textContent = masterDataRows[idx]["Ship From"] || '';
          });
          td.appendChild(input);
        } else if (key === "Custom Field 1" || key === "Custom Field 2" || key === "Custom Field 3") {
          const input = document.createElement('input');
          input.type = 'text';
          input.className = 'cf-edit';
          input.value = row[key] || '';
          input.placeholder = key;
          input.addEventListener('change', (e) => {
            masterDataRows[idx][key] = e.target.value || '';
          });
          td.appendChild(input);
        } else {
          td.textContent = row[key] || '';
        }
        tr.appendChild(td);
      });
      return tr;
    }

    // Sales Order row builder with new headers/mapping (data unchanged)
    function buildOrderRowTr(row){
      const tr = document.createElement('tr');
      const map = [
        ["Order Date","Order Date"],
        ["Ship From","Ship From"],
        ["Order Number","Order Number"],
        ["Item SKU","Item SKU"],
        ["Quantity","Quantity"],
        ["Custom Field 1","Custom Field 1"],
        ["Custom Field 2","Custom Field 2"],
        ["Custom Field 3","Custom Field 3"],
        ["Order Total","Order Total"],
        ["Recipient","Recipient"],
        ["Carrier Fee","Rate"],
        ["Service","Service"],
        ["Tracking Number","Tracking Number"],
        ["PO Reference Number","PO Number"],
        ["Memo",""]
      ];
      map.forEach(([header, key]) => {
        let val = key ? (row[key] || '') : '';
        if (header === "Service") val = (val+'').replace(/Â®/g,'');
        const td = document.createElement('td'); td.textContent = val; tr.appendChild(td);
      });
      return tr;
    }

    function buildSalesOrderLines(baseRow){
      const lines = [];
      const cfParts = [baseRow["Custom Field 1"], baseRow["Custom Field 2"]]
        .map(v => (v || '').toString().trim())
        .filter(v => v.length > 0)
        .sort((a,b) => a.localeCompare(b, undefined, {numeric:true, sensitivity:'base'}));
      const common = {
        "Order Date": baseRow["Order Date"],
        "Ship From": baseRow["Ship From"],
        "Order Number": baseRow["Order Number"],
        "Item SKU": baseRow["Item SKU"],
        "Quantity": baseRow["Quantity"] || 1,
        "Order Total": baseRow["Order Total"],
        "Recipient": baseRow["Recipient"],
        "PO Number": baseRow["PO Number"],
        "Rate": baseRow["Rate"] || "",
        "Service": (baseRow["Service"] || "").replace(/Â®/g,''),
        "Tracking Number": baseRow["Tracking Number"] || ""
      };
      // Item lines (no shipping data)
      cfParts.forEach(val => {
        lines.push({...common, "Custom Field 1": val, "Custom Field 2": "", "Custom Field 3": "", "Rate":"", "Service":"", "Tracking Number":""});
      });
      // Shipping line
      lines.push({...common, "Custom Field 1":"Shipping (WD)", "Custom Field 2":"", "Custom Field 3":"", "Rate": baseRow["Rate"] || "", "Service": (baseRow["Service"] || "").replace(/Â®/g,''), "Tracking Number": baseRow["Tracking Number"] || ""});
      return lines;
    }

    function renderSalesOrder(){
      const tbody = document.getElementById('orderTable').querySelector('tbody');
      tbody.innerHTML = '';
      const exploded = masterDataRows.flatMap(r => buildSalesOrderLines(r));
      document.getElementById('totalOrders').textContent = `Total Orders (lines): ${exploded.length}`;
      const counts = {}; exploded.forEach(r => { counts[r["Order Date"]] = (counts[r["Order Date"]] || 0) + 1; });
      const parts = Object.entries(counts).map(([d,c]) => `${d}: ${c}`);
      document.getElementById('ordersByDate').textContent = `Lines by Date: ${parts.join('    |    ')}`;
      exploded.forEach(row => tbody.appendChild(buildOrderRowTr(row)));
    }

    function exportCurrent(){
      let fn = document.getElementById('exportFilename').value.trim() || (currentView==='order' ? 'Sales_Order' : 'Sales_Report');
      fn = fn.replace(/\.xlsx$/i,'');
      let headers, data;

      if(currentView==='order'){
        const exploded = masterDataRows.flatMap(r => buildSalesOrderLines(r));
        headers = ["Order Date","Ship From","Order Number","Item SKU","Quantity","Custom Field 1","Custom Field 2","Custom Field 3","Order Total","Recipient","Carrier Fee","Service","Tracking Number","PO Reference Number","Memo"];
        data = exploded.map(r => ({
          "Order Date": r["Order Date"] || "",
          "Ship From": r["Ship From"] || "",
          "Order Number": r["Order Number"] || "",
          "Item SKU": r["Item SKU"] || "",
          "Quantity": r["Quantity"] || "",
          "Custom Field 1": r["Custom Field 1"] || "",
          "Custom Field 2": r["Custom Field 2"] || "",
          "Custom Field 3": r["Custom Field 3"] || "",
          "Order Total": r["Order Total"] || "",
          "Recipient": r["Recipient"] || "",
          "Carrier Fee": r["Rate"] || "",
          "Service": (r["Service"] || ""),
          "Tracking Number": r["Tracking Number"] || "",
          "PO Reference Number": r["PO Number"] || "",
          "Memo": ""
        }));
      } else {
        headers = ["Order Date","Ship From","Order Number","Item SKU","Quantity","Custom Field 1","Custom Field 2","Custom Field 3","Order Total","Recipient","Rate","Service","Tracking Number","PO Number"];
        data = masterDataRows.map(r => {
          const obj = {};
          headers.forEach(h => obj[h] = r[h] || '');
          return obj;
        });
      }

      const ws = XLSX.utils.json_to_sheet(data, {header: headers});
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, currentView==='order' ? 'Sales Order' : 'Sales Report');
      XLSX.writeFile(wb, fn + '.xlsx');
    }

    function resetAll() {
      masterDataRows = []; masterOrderNumbers.clear(); isFirstFile = true; updateFilesCount = 0;
      document.getElementById('fileInput').value = '';
      document.getElementById('totalOrders').textContent = 'Total Orders: 0';
      document.getElementById('ordersByDate').textContent = currentView==='order' ? 'Lines by Date:' : 'Orders by Date:';
      document.querySelector('#reportTable tbody').innerHTML = '';
      document.querySelector('#orderTable tbody').innerHTML = '';
      switchView('report');
    }
  </script>

<script id="kp360-empty-highlight-script">
(function(){
  function norm(s){ return String(s||'').trim().replace(/\s+/g,' ').toUpperCase(); }

  function isEmpty(v){
    if (v == null) return true;
    if (typeof v === 'string') return v.trim() === '';
    // support inputs inside cells
    if (v instanceof HTMLElement){
      if (v.tagName === 'INPUT' || v.tagName === 'TEXTAREA') return v.value.trim() === '';
      return v.textContent.trim() === '';
    }
    return String(v).trim() === '';
  }

  function hasSkuPLXorPAIR(s){ s = String(s||'').toUpperCase(); return /\bPLX\b/.test(s) || /\bPAIR\b/.test(s); }

  function buildHeaderMap(table){
    const map = {};
    const ths = table.querySelectorAll('thead th');
    ths.forEach((th, i) => { map[norm(th.textContent)] = i; });
    return map;
  }

  function getCell(tr, idx){ return idx != null ? tr.children[idx] : null; }
  function cellVal(td){
    if (!td) return '';
    const inp = td.querySelector('input,textarea,select');
    if (inp) return (inp.value || '').trim();
    return (td.textContent || '').trim();
  }

  function highlightTable(table){
    if (!table || !table.tHead || !table.tBodies.length) return;

    const H = buildHeaderMap(table);
    // Canonical header keys (normalize both Report and Order views)
    const idx = {
      SHIP_FROM: H[norm('Ship From')],
      ITEM_SKU: H[norm('Item SKU')],
      CF1: H[norm('Custom Field 1')],
      CF2: H[norm('Custom Field 2')],
      SERVICE: H[norm('Service')] ?? H[norm('Carrier')],
      CARRIER_FEE: H[norm('Rate')] ?? H[norm('Carrier Fee')],
      TRACKING: H[norm('Tracking Number')],
      PO_NUM: H[norm('PO Number')] ?? H[norm('PO Reference Number')]
    };

    const isSalesOrderView = idx.SERVICE != null && table.getAttribute('data-view') === 'order' ? true : false;

    for (const tbody of table.tBodies){
      for (const tr of tbody.rows){
        // clear prior classes
        tr.querySelectorAll('td.kp-hl-red,td.kp-hl-yellow').forEach(td => { td.classList.remove('kp-hl-red','kp-hl-yellow'); });

        const val = {
          shipFrom: cellVal(getCell(tr, idx.SHIP_FROM)),
          itemSku: cellVal(getCell(tr, idx.ITEM_SKU)),
          cf1: cellVal(getCell(tr, idx.CF1)),
          cf2: cellVal(getCell(tr, idx.CF2)),
          service: cellVal(getCell(tr, idx.SERVICE)),
          fee: cellVal(getCell(tr, idx.CARRIER_FEE)),
          tracking: cellVal(getCell(tr, idx.TRACKING)),
          po: cellVal(getCell(tr, idx.PO_NUM)),
        };

        // Light Red
        if (idx.SHIP_FROM != null && isEmpty(val.shipFrom)) getCell(tr, idx.SHIP_FROM)?.classList.add('kp-hl-red');
        if (idx.CF1 != null && isEmpty(val.cf1)) getCell(tr, idx.CF1)?.classList.add('kp-hl-red');
        if (idx.ITEM_SKU != null && idx.CF2 != null && hasSkuPLXorPAIR(val.itemSku) && isEmpty(val.cf2)) getCell(tr, idx.CF2)?.classList.add('kp-hl-red');
        if (idx.PO_NUM != null && isEmpty(val.po)) getCell(tr, idx.PO_NUM)?.classList.add('kp-hl-red');

        // Light Yellow
        // Report view: highlight all rows
        // Sales Order view: ONLY highlight "Shipping (WD)" line
        let allowYellow = true;
        const cf1Upper = norm(val.cf1);
        if (cf1Upper && cf1Upper.length){
          // heuristic: many tables don't label data-view, so infer SO by the "Shipping (WD)" rule
          // If the row is not "Shipping (WD)", then yellow only if not an SO view or it's the shipping line
          // We'll implement: if table *appears* to be SO (has PO Reference Number or similar) then constrain to Shipping (WD)
        }
        const looksLikeSalesOrder = (H[norm('PO Reference Number')] != null) || (table.getAttribute('data-view') === 'order');
        if (looksLikeSalesOrder){
          allowYellow = (cf1Upper === 'SHIPPING (WD)');
        }

        if (allowYellow){
          if (idx.SERVICE != null && isEmpty(val.service)) getCell(tr, idx.SERVICE)?.classList.add('kp-hl-yellow');
          if (idx.CARRIER_FEE != null && isEmpty(val.fee)) getCell(tr, idx.CARRIER_FEE)?.classList.add('kp-hl-yellow');
          if (idx.TRACKING != null && isEmpty(val.tracking)) getCell(tr, idx.TRACKING)?.classList.add('kp-hl-yellow');
        }
      }
    }
  }

  function highlightAll(){
    const tables = document.querySelectorAll('table');
    tables.forEach(highlightTable);
  }

  // Debounced observe
  let t = null;
  function schedule(){ if (t) cancelAnimationFrame(t); t = requestAnimationFrame(highlightAll); }

  document.addEventListener('DOMContentLoaded', schedule);
  window.addEventListener('load', schedule);

  const obs = new MutationObserver((muts) => {
    for (const m of muts){
      if (m.type === 'childList' || m.type === 'attributes'){
        schedule();
        break;
      }
    }
  });
  obs.observe(document.documentElement || document.body, {subtree:true, childList:true, attributes:true});
})();
</script>

<script id="kp360-service-col-script">
(function(){
  function norm(s){ return String(s||'').trim().replace(/\s+/g,' ').toUpperCase(); }
  function markServiceColumn(table){
    if (!table || !table.tHead) return;
    var ths = table.tHead.querySelectorAll('th');
    var idx = -1;
    for (var i=0;i<ths.length;i++){
      var t = norm(ths[i].textContent);
      if (t === 'SERVICE' || t === 'CARRIER'){
        idx = i; break;
      }
    }
    if (idx < 0) return;
    ths[idx].classList.add('kp-service-col');
    for (var b=0;b<table.tBodies.length;b++){
      var rows = table.tBodies[b].rows;
      for (var r=0;r<rows.length;r++){
        if (rows[r].children[idx]) rows[r].children[idx].classList.add('kp-service-col');
      }
    }
  }
  function apply(){
    var tables = document.querySelectorAll('table');
    for (var i=0;i<tables.length;i++) markServiceColumn(tables[i]);
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', apply);
  } else { apply(); }
  // Re-apply on mutations in case the table rerenders
  var obs = new MutationObserver(function(m){
    for (var i=0;i<m.length;i++){
      if (m[i].type === 'childList'){ apply(); break; }
    }
  });
  obs.observe(document.documentElement||document.body, {subtree:true, childList:true});
})();
</script>

<script id="kp360-cf2-sales-report-only">
(function(){
  function norm(s){ return String(s||'').trim().replace(/\s+/g,' ').toUpperCase(); }
  function headerIndex(table, name){
    if (!table || !table.tHead) return -1;
    var ths = table.tHead.querySelectorAll('th');
    for (var i=0;i<ths.length;i++){
      if (norm(ths[i].textContent) === norm(name)) return i;
    }
    return -1;
  }
  function looksLikeSalesOrder(table){
    // Sales Order view in this app uses "PO Reference Number"
    return headerIndex(table,'PO REFERENCE NUMBER') >= 0;
  }
  function apply(){
    var tables = document.querySelectorAll('table');
    for (var t=0;t<tables.length;t++){
      var table = tables[t];
      if (!looksLikeSalesOrder(table)) continue; // rule only needs to remove on SO

      var cf2Idx = headerIndex(table,'CUSTOM FIELD 2');
      if (cf2Idx < 0) continue;
      for (var b=0;b<table.tBodies.length;b++){
        var rows = table.tBodies[b].rows;
        for (var r=0;r<rows.length;r++){
          var td = rows[r].children[cf2Idx];
          if (td) td.classList.remove('kp-hl-red'); // ensure CF2 never red-highlighted on SO
        }
      }
    }
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', apply);
  } else { apply(); }
  // re-apply on DOM mutations
  var obs = new MutationObserver(function(m){ for (var i=0;i<m.length;i++){ if (m[i].type==='childList'){ apply(); break; }}});
  obs.observe(document.documentElement||document.body, {subtree:true, childList:true});
})();
</script>

<script id="kp360-row-warning-script">
(function(){
  function norm(s){ return String(s||'').trim().replace(/\s+/g,' ').toUpperCase(); }
  function headerIndex(table, name){
    if (!table || !table.tHead) return -1;
    var ths = table.tHead.querySelectorAll('th');
    var key = norm(name);
    for (var i=0;i<ths.length;i++){
      if (norm(ths[i].textContent) === key) return i;
    }
    return -1;
  }
  function val(td){
    if (!td) return '';
    var inp = td.querySelector('input,textarea,select');
    if (inp) return (inp.value||'').trim();
    return (td.textContent||'').trim();
  }
  function hasVendorSKU(s){
    s = norm(s);
    return /\bUSAUTO\b/.test(s) || /\BMEYER\b/.test(s) || /\BTONSA\b/.test(s) || /\bUS AUTO\b/.test(s);
  }
  function apply(){
    var tables = document.querySelectorAll('table');
    for (var t=0;t<tables.length;t++){
      var table = tables[t];
      if (!table.tBodies || !table.tBodies.length) continue;

      var idxSKU = headerIndex(table, 'ITEM SKU');
      var idxFee = headerIndex(table, 'CARRIER FEE');
      if (idxFee < 0) idxFee = headerIndex(table, 'RATE'); // Report uses "Rate"
      var idxPO  = headerIndex(table, 'PO NUMBER') >= 0 ? headerIndex(table, 'PO NUMBER') : headerIndex(table, 'PO REFERENCE NUMBER');

      for (var b=0;b<table.tBodies.length;b++){
        var rows = table.tBodies[b].rows;
        for (var r=0;r<rows.length;r++){
          var tr = rows[r];
          tr.classList.remove('kp-row-warn');
          var sku = val(tr.children[idxSKU]);
          var fee = val(tr.children[idxFee]);
          var po  = val(tr.children[idxPO]);
          if (idxSKU>=0 && idxFee>=0 && hasVendorSKU(sku) && fee !== '' && (po === '' || po == null)){
            tr.classList.add('kp-row-warn');
          }
        }
      }
    }
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', apply);
  } else { apply(); }
  // re-apply on DOM changes
  var obs = new MutationObserver(function(m){ for (var i=0;i<m.length;i++){ if (m[i].type==='childList'){ apply(); break; }}});
  obs.observe(document.documentElement||document.body, {subtree:true, childList:true});
})();
</script>

<script id="kp360-cf2-ignore-fba">
(function(){
  function norm(s){ return String(s||'').trim().toUpperCase(); }
  function headerIndex(table, name){
    if (!table || !table.tHead) return -1;
    var ths = table.tHead.querySelectorAll('th');
    var key = norm(name);
    for (var i=0;i<ths.length;i++){ if (norm(ths[i].textContent) === key) return i; }
    return -1;
  }
  function looksLikeSalesOrder(table){
    return headerIndex(table,'PO REFERENCE NUMBER') >= 0;
  }
  function val(td){
    if (!td) return '';
    var inp = td.querySelector('input,textarea,select');
    if (inp) return (inp.value||'').trim();
    return (td.textContent||'').trim();
  }
  function apply(){
    var tables = document.querySelectorAll('table');
    for (var t=0;t<tables.length;t++){
      var table = tables[t];
      // Apply only on Sales Report (skip SO)
      if (looksLikeSalesOrder(table)) continue;
      var idxSKU = headerIndex(table,'ITEM SKU');
      var idxCF2 = headerIndex(table,'CUSTOM FIELD 2');
      if (idxSKU < 0 || idxCF2 < 0) continue;

      for (var b=0;b<table.tBodies.length;b++){
        var rows = table.tBodies[b].rows;
        for (var r=0;r<rows.length;r++){
          var sku = norm(val(rows[r].children[idxSKU]));
          if (/(\b|[^A-Z0-9])FBA(\b|[^A-Z0-9])/.test(sku)){
            var td = rows[r].children[idxCF2];
            if (td) td.classList.remove('kp-hl-red');
          }
        }
      }
    }
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', apply);
  } else { apply(); }
  var obs = new MutationObserver(function(m){ for (var i=0;i<m.length;i++){ if (m[i].type === 'childList'){ apply(); break; }}});
  obs.observe(document.documentElement||document.body, {subtree:true, childList:true});
})();
</script>

<script id="kp360-row-warning-shipfrom">
(function(){
  function norm(s){ return String(s||'').trim().replace(/\s+/g,' ').toUpperCase(); }
  function headerIndex(table, name){
    if (!table || !table.tHead) return -1;
    var ths = table.tHead.querySelectorAll('th');
    var key = norm(name);
    for (var i=0;i<ths.length;i++){
      if (norm(ths[i].textContent) === key) return i;
    }
    return -1;
  }
  function val(td){
    if (!td) return '';
    var inp = td.querySelector('input,textarea,select');
    if (inp) return (inp.value||'').trim();
    return (td.textContent||'').trim();
  }
  function shipFromMatches(s){
    s = norm(s);
    return /\bUSAUTO\b/.test(s) || /\bUS AUTO\b/.test(s) || /\BMEYER\b/.test(s) || /\BTONSA\b/.test(s);
  }
  function apply(){
    var tables = document.querySelectorAll('table');
    for (var t=0;t<tables.length;t++){
      var table = tables[t];
      if (!table.tBodies || !table.tBodies.length) continue;

      var idxShipFrom = headerIndex(table, 'SHIP FROM');
      var idxFee = headerIndex(table, 'CARRIER FEE');
      if (idxFee < 0) idxFee = headerIndex(table, 'RATE'); // Report uses "Rate"

      if (idxShipFrom < 0 || idxFee < 0) continue;

      for (var b=0;b<table.tBodies.length;b++){
        var rows = table.tBodies[b].rows;
        for (var r=0;r<rows.length;r++){
          var tr = rows[r];
          // clear any previous row-warn from older rule
          tr.classList.remove('kp-row-warn');

          var ship = val(tr.children[idxShipFrom]);
          var fee  = val(tr.children[idxFee]);

          if (shipFromMatches(ship) && fee !== ''){
            tr.classList.add('kp-row-warn'); // entire line light yellow (style already defined)
          }
        }
      }
    }
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', apply);
  } else { apply(); }
  // re-apply on DOM changes
  var obs = new MutationObserver(function(m){ for (var i=0;i<m.length;i++){ if (m[i].type==='childList'){ apply(); break; }}});
  obs.observe(document.documentElement||document.body, {subtree:true, childList:true});
})();
</script>

<script id="kp360-tip-bubble-script">
(function(){
  // Utilities
  function norm(s){ return String(s||'').trim().replace(/\s+/g,' ').toUpperCase(); }
  function headerIndex(table, name){
    if (!table || !table.tHead) return -1;
    var ths = table.tHead.querySelectorAll('th');
    var key = norm(name);
    for (var i=0;i<ths.length;i++){ if (norm(ths[i].textContent) === key) return i; }
    return -1;
  }
  function getHeaderText(table, idx){
    if (!table || !table.tHead) return '';
    var ths = table.tHead.querySelectorAll('th');
    if (idx >= 0 && idx < ths.length) return (ths[idx].textContent||'').trim();
    return '';
  }
  function val(td){
    if (!td) return '';
    var inp = td.querySelector('input,textarea,select');
    if (inp) return (inp.value||'').trim();
    return (td.textContent||'').trim();
  }
  function looksLikeSalesOrder(table){
    return headerIndex(table,'PO REFERENCE NUMBER') >= 0;
  }
  function hasPLXorPAIR(s){ s = norm(s); return /\bPLX\b/.test(s) || /\bPAIR\b/.test(s); }
  function hasFBA(s){ s = norm(s); return /(^|[^A-Z0-9])FBA([^A-Z0-9]|$)/.test(s); }
  function shipFromVendor(s){ s = norm(s); return (/\bUSAUTO\b/.test(s) || /\bUS AUTO\b/.test(s) || /MEYER/.test(s) || /TONSA/.test(s)); }

  // Tooltip element
  var tip = document.createElement('div');
  tip.className = 'kp-tip';
  document.body.appendChild(tip);

  var currentTarget = null;

  function showTip(target, html){
    tip.innerHTML = html;
    tip.classList.add('show');
    currentTarget = target;
  }
  function hideTip(){
    tip.classList.remove('show');
    currentTarget = null;
  }
  function positionTip(ev){
    var x = ev.clientX + 12;
    var y = ev.clientY + 12;
    var w = tip.offsetWidth, h = tip.offsetHeight;
    var vw = document.documentElement.clientWidth;
    var vh = document.documentElement.clientHeight;
    if (x + w + 12 > vw) x = Math.max(8, vw - w - 12);
    if (y + h + 12 > vh) y = Math.max(8, vh - h - 12);
    tip.style.left = x + 'px';
    tip.style.top = y + 'px';
  }

  function reasonForCell(td){
    var table = td.closest('table');
    var idx = Array.prototype.indexOf.call(td.parentNode.children, td);
    var header = getHeaderText(table, idx);
    var clsRed = td.classList.contains('kp-hl-red');
    var clsYellow = td.classList.contains('kp-hl-yellow');

    // Gather row values for special rules
    var idxSKU = headerIndex(table,'ITEM SKU');
    var idxCF2 = headerIndex(table,'CUSTOM FIELD 2');
    var idxService = headerIndex(table,'SERVICE'); if (idxService<0) idxService = headerIndex(table,'CARRIER');
    var idxRate = headerIndex(table,'CARRIER FEE'); if (idxRate<0) idxRate = headerIndex(table,'RATE');
    var idxTrack = headerIndex(table,'TRACKING NUMBER');
    var idxShipFrom = headerIndex(table,'SHIP FROM');

    var tr = td.parentNode;
    var sku = idxSKU>=0 ? val(tr.children[idxSKU]) : '';
    var shipFrom = idxShipFrom>=0 ? val(tr.children[idxShipFrom]) : '';

    if (clsRed){
      if (norm(header) === 'CUSTOM FIELD 2'){
        if (!looksLikeSalesOrder(table) && hasPLXorPAIR(sku) && !hasFBA(sku)){
          return '<span class="kp-tip-head">Missing required field</span><span class="kp-tip-rule">Custom Field 2 is required for PLX/PAIR SKUs on the Sales Report (ignored if SKU contains FBA).</span>';
        }
        return '<span class="kp-tip-head">Missing value</span><span class="kp-tip-rule">Custom Field 2 is empty.</span>';
      }
      return '<span class="kp-tip-head">Missing value</span><span class="kp-tip-rule">'+(header||'This field')+' is required.</span>';
    }
    if (clsYellow){
      if (idxService===idx) return '<span class="kp-tip-head">Carrier Missing</span><span class="kp-tip-rule">Please provide a carrier/service.</span>';
      if (idxRate===idx) return '<span class="kp-tip-head">Carrier Fee Missing</span><span class="kp-tip-rule">Please provide a fee if applicable.</span>';
      if (idxTrack===idx) return '<span class="kp-tip-head">Tracking Number Missing</span><span class="kp-tip-rule">Add tracking when available.</span>';
      return '<span class="kp-tip-head">Needs attention</span><span class="kp-tip-rule">'+(header||'This field')+' is empty.</span>';
    }
    // If part of a row-warn, defer to row reason
    if (td.parentNode.classList.contains('kp-row-warn')){
      return reasonForRow(td.parentNode);
    }
    return '<span class="kp-tip-head">Info</span><span class="kp-tip-rule">Highlighted cell.</span>';
  }

  function reasonForRow(tr){
    var table = tr.closest('table');
    var idxShipFrom = headerIndex(table,'SHIP FROM');
    var idxRate = headerIndex(table,'CARRIER FEE'); if (idxRate<0) idxRate = headerIndex(table,'RATE');
    var ship = idxShipFrom>=0 ? val(tr.children[idxShipFrom]) : '';
    var fee = idxRate>=0 ? val(tr.children[idxRate]) : '';
    if (shipFromVendor(ship) && fee !== ''){
      return '<span class="kp-tip-head">Review: Unexpected Carrier Fee</span><span class="kp-tip-rule">This line has a Carrier Fee, but Ship From is '+(ship||'vendor')+'.</span>';
    }
    return '<span class="kp-tip-head">Row highlighted</span><span class="kp-tip-rule">Please review this line.</span>';
  }

  function attachHandlers(){
    // target all highlighted cells and rows
    var cells = document.querySelectorAll('td.kp-hl-red, td.kp-hl-yellow, tr.kp-row-warn > td');
    cells.forEach(function(td){
      // Avoid duplicate listeners
      if (td._kpTipBound) return;
      td._kpTipBound = true;
      td.addEventListener('mouseenter', function(ev){
        var html = td.parentNode.classList.contains('kp-row-warn') ? reasonForRow(td.parentNode) : reasonForCell(td);
        showTip(td, html); positionTip(ev);
      });
      td.addEventListener('mousemove', positionTip);
      td.addEventListener('mouseleave', hideTip);
      td.addEventListener('scroll', hideTip, {passive:true});
    });
  }

  function scheduleAttach(){
    attachHandlers();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', scheduleAttach);
  } else { scheduleAttach(); }

  // Re-attach on DOM updates
  var obs = new MutationObserver(function(m){ for (var i=0;i<m.length;i++){ if (m[i].type==='childList' || m[i].type==='attributes'){ scheduleAttach(); break; }}});
  obs.observe(document.documentElement||document.body, {subtree:true, childList:true, attributes:true});
})();
</script>
</body>
</html>
