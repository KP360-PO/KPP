<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AAG NS File Generator</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1b1f23, #2c3e50);
      color: #fff;
      margin: 0;
      padding: 0;
      background-image: url('https://images.unsplash.com/photo-1503376780353-7e6692767b70?auto=format&fit=crop&w=1350&q=80');
      background-size: cover;
      background-position: center;
      backdrop-filter: blur(5px);
    }
    h1 {
      text-align: center;
      font-size: 2rem;
      margin: 30px 0;
      color: #ffffffcc;
      text-shadow: 0 0 6px #000;
    }
    .container {
      width: 100%;
      padding: 30px 50px;
      background: rgba(0, 0, 0, 0.7);
      box-sizing: border-box;
    }
    .drop-zone {
      border: 2px dashed #888;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      margin-bottom: 20px;
      background-color: rgba(255, 255, 255, 0.05);
      transition: background-color 0.3s ease, border-color 0.3s;
    }
    .drop-zone:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    .drop-zone.dragover {
      background-color: rgba(30, 144, 255, 0.3);
      border-color: #1f6feb;
    }
    .drop-zone-text {
      font-size: 0.9rem;
      color: #ccc;
    }
    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    .button-group button {
      border: none;
      border-radius: 50px;
      padding: 12px 24px;
      font-size: 0.95rem;
      font-weight: 600;
      text-shadow: 0 1px 2px #000;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .button-group button:hover {
      transform: scale(1.05);
    }
    .green-btn { background-color: #2ecc71; color: #fff; }
    .amber-btn { background-color: #f1c40f; color: #000; }
    .blue-btn { background-color: #3498db; color: #fff; }
    .red-btn { background-color: #e74c3c; color: #fff; }
    #tableContainer {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background-color: rgba(255, 255, 255, 0.1);
      color: #fff;
      font-size: 0.85rem;
      border-radius: 8px;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #666;
      text-align: left;
      word-break: break-word;
    }
    th {
      background-color: rgba(255, 255, 255, 0.15);
      position: sticky;
      top: 0;
      z-index: 2;
    }
    td[contenteditable] {
      background-color: rgba(255, 255, 255, 0.05);
    }
    td[contenteditable]:focus {
      background-color: #ffffcc;
      color: #000;
      outline: 2px solid #3498db;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>AAG NS File Generator</h1>

    <div class="drop-zone" id="poDropZone">
      <label for="fileInput">PO File (drag or click)</label>
      <input type="file" id="fileInput" accept=".xlsx, .xls" hidden />
      <p class="drop-zone-text">Drop PO Excel file here or click to upload</p>
    </div>

    <div class="drop-zone" id="trackingDropZone">
      <label for="matchFileInput">Tracking Details File (drag or click)</label>
      <input type="file" id="matchFileInput" accept=".xlsx, .xls" hidden />
      <p class="drop-zone-text">Drop Tracking Excel file here or click to upload</p>
    </div>

    <div class="button-group">
      <button class="green-btn" onclick="generateMappedData()">Generate File</button>
      <button class="amber-btn" onclick="mergeCarrierTracking()">Merge Carrier & Tracking Info</button>
      <button class="blue-btn" onclick="downloadExcel()">Download File</button>
      <button class="red-btn" onclick="clearData()">Clear</button>
    </div>

    <div id="tableContainer"></div>
  </div>

  <script>
    let mappedData = [];

    function setupDropZone(dropZoneId, inputId) {
      const dropZone = document.getElementById(dropZoneId);
      const input = document.getElementById(inputId);

      dropZone.addEventListener('click', () => input.click());
      dropZone.addEventListener('dragover', e => {
        e.preventDefault();
        dropZone.classList.add('dragover');
      });
      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
      });
      dropZone.addEventListener('drop', e => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length) {
          input.files = files;
          if (inputId === 'fileInput') generateMappedData();
          else if (inputId === 'matchFileInput') mergeCarrierTracking();
        }
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      setupDropZone("poDropZone", "fileInput");
      setupDropZone("trackingDropZone", "matchFileInput");
    });

    function getValueBelow(sheet, coord, offset) {
      if (!coord) return "";
      const addr = XLSX.utils.encode_cell({ r: coord.r + 1 + offset, c: coord.c });
      const cell = sheet[addr];
      return cell?.v || "";
    }

    function formatExcelDate(raw) {
      if (typeof raw === "number") {
        const date = XLSX.SSF.parse_date_code(raw);
        return `${String(date.m).padStart(2, '0')}/${String(date.d).padStart(2, '0')}/${date.y}`;
      } else if (typeof raw === "string") {
        const parsed = new Date(raw);
        return !isNaN(parsed) ? `${String(parsed.getMonth() + 1).padStart(2, '0')}/${String(parsed.getDate()).padStart(2, '0')}/${parsed.getFullYear()}` : "";
      }
      return "";
    }

    function generateMappedData() {
      mappedData = [];
      const file = document.getElementById("fileInput").files[0];
      if (!file) return alert("Please select a PO file.");
      const reader = new FileReader();
      reader.onload = function (e) {
        const workbook = XLSX.read(e.target.result, { type: "binary" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const range = XLSX.utils.decode_range(sheet['!ref']);
        const headersMap = {};

        for (let R = range.s.r; R <= range.e.r; ++R) {
          for (let C = range.s.c; C <= range.e.c; ++C) {
            const cell = sheet[XLSX.utils.encode_cell({ r: R, c: C })];
            if (!cell || !cell.v) continue;
            const val = cell.v.toString().trim().toLowerCase();
            if (["date submitted", "po number", "order #", "item #", "qty", "customer's name", "unit price", "amount"].includes(val)) {
              headersMap[val] = { r: R, c: C };
            }
          }
        }

        const clpoValue = getValueBelow(sheet, headersMap["po number"], 0);
        const dateRaw = getValueBelow(sheet, headersMap["date submitted"], 0);
        const formattedDate = formatExcelDate(dateRaw);

        const maxLength = Math.max(...["order #", "item #", "qty", "customer's name", "unit price", "amount"].map(key => {
          const loc = headersMap[key]; if (!loc) return 0;
          let len = 0;
          while (sheet[XLSX.utils.encode_cell({ r: loc.r + 1 + len, c: loc.c })]?.v) len++;
          return len;
        }));

        for (let i = 0; i < maxLength; i++) {
          const itemValue = getValueBelow(sheet, headersMap["item #"], i).toString().trim();
          if (itemValue.toLowerCase() === "total") continue;

          mappedData.push({
            "Date": formattedDate,
            "Reference PO": "",
            "CLPO #": clpoValue,
            "Order #": getValueBelow(sheet, headersMap["order #"], i),
            "ITEM #": itemValue.toUpperCase(),
            "QTY": getValueBelow(sheet, headersMap["qty"], i),
            "Customer's Name": getValueBelow(sheet, headersMap["customer's name"], i),
            "Unit Price": parseFloat(getValueBelow(sheet, headersMap["unit price"], i) || 0).toFixed(2),
            "Amount": parseFloat(getValueBelow(sheet, headersMap["amount"], i) || 0).toFixed(2),
            "Carrier": "",
            "Tracking Number": "",
            "Location": "",
            "SO NUMBER": ""
          });
        }

        displayTable(mappedData);
      };
      reader.readAsBinaryString(file);
    }

    function displayTable(data) {
      const container = document.getElementById("tableContainer");
      if (!data.length) return container.innerHTML = "<p>No data to display.</p>";

      let table = "<table><thead><tr>";
      Object.keys(data[0]).forEach(key => table += `<th>${key}</th>`);
      table += "</tr></thead><tbody>";

      data.forEach((row, i) => {
        table += "<tr>";
        Object.keys(row).forEach(key => {
          table += `<td contenteditable oninput="updateCell(${i}, '${key}', this.innerText)">${row[key]}</td>`;
        });
        table += "</tr>";
      });

      table += "</tbody></table>";
      container.innerHTML = table;
    }

    function updateCell(i, key, val) {
      if (key === "ITEM #") {
        val = val.toUpperCase();
      }
      mappedData[i][key] = val.trim();
    }

    function mergeCarrierTracking() {
      const file = document.getElementById("matchFileInput").files[0];
      if (!file) return alert("Please upload a tracking file.");

      const reader = new FileReader();
      reader.onload = function (e) {
        const workbook = XLSX.read(e.target.result, { type: "binary" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });

        const lookupMap = {};
        json.forEach(row => {
          const orderKey = (row["Order #"] || row["order #"] || "").toString().trim();
          const carrier = row["Carrier"] || row["carrier"] || "";
          const tracking = row["Tracking Number"] || row["tracking number"] || "";
          if (orderKey && (carrier || tracking)) {
            lookupMap[orderKey] = { Carrier: carrier, TrackingNumber: tracking };
          }
        });

        mappedData.forEach(row => {
          const key = (row["Order #"] || "").toString().trim();
          if (lookupMap[key]) {
            row["Carrier"] = lookupMap[key].Carrier;
            row["Tracking Number"] = lookupMap[key].TrackingNumber;
          }

          const clpo = row["CLPO #"] || "";
          if (clpo.endsWith("-NJ")) row["Location"] = "New Jersey Distribution Warehouse";
          else if (clpo.endsWith("-CA")) row["Location"] = "California Distribution Warehouse";
          else row["Location"] = "";
        });

        displayTable(mappedData);
        alert("Carrier, Tracking Number, and Location updated.");
      };

      reader.readAsBinaryString(file);
    }

    function downloadExcel() {
      if (!mappedData.length) return alert("No data to export.");

      const adjusted = mappedData.map(row => {
        const trackingFormatted = /^\d{10,}$/.test(row["Tracking Number"])
          ? `="${row["Tracking Number"]}"`
          : row["Tracking Number"];

        return {
          ...row,
          "ITEM #": (row["ITEM #"] || "").toString().toUpperCase(),
          "Tracking Number": trackingFormatted
        };
      });

      const worksheet = XLSX.utils.json_to_sheet(adjusted);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Mapped Data");
      XLSX.writeFile(workbook, "mapped_data.csv");
    }

    function clearData() {
      mappedData = [];
      document.getElementById("tableContainer").innerHTML = "";
      document.getElementById("fileInput").value = "";
      document.getElementById("matchFileInput").value = "";
    }
  </script>
</body>
</html>
