<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Carrier Count Processor</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; }
    h2 { margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #999; padding: 8px; text-align: center; }
    th { background: #f7e6b5; cursor: pointer; }
    .hidden { display: none; }
  </style>
</head>
<body>

<h2>Upload ShipStation CSV</h2>
<input type="file" id="csvFile" accept=".csv" />

<h3 id="dateHeader" class="hidden">Carrier count for <span id="reportDate"></span></h3>

<table id="carrierTable" class="hidden">
  <thead>
    <tr>
      <th onclick="sortTable(0)">Warehouse</th>
      <th onclick="sortTable(1)">USPS</th>
      <th onclick="sortTable(2)">UPS</th>
      <th onclick="sortTable(3)">FEDEX</th>
      <th onclick="sortTable(4)">ONTRAC</th>
      <th onclick="sortTable(5)">Amazon Logistics</th>
      <th onclick="sortTable(6)">Total</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<script>
const carriers = ['USPS', 'UPS', 'FEDEX', 'ONTRAC', 'Amazon Logistics'];
const warehouseMap = [
  { keywords: ['NJ', 'NY'], names: ['KP360', 'WooParts', 'KEMA', 'AutoApex'], region: 'New Jersey' },
  { keywords: ['CALI', 'CA'], names: ['KP360', 'WooParts', 'KEMA', 'AutoApex'], region: 'California' },
  { keywords: ['GEORGIA', 'GA'], names: ['KP360', 'WooParts', 'KEMA', 'AutoApex'], region: 'Georgia' },
  { keywords: ['IL'], names: ['KP360', 'WooParts', 'KEMA', 'AutoApex'], region: 'Illinois' }
];

document.getElementById('csvFile').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;

  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      processData(results.data);
    }
  });
});

function mapWarehouse(name) {
  if (!name) return 'Unknown';
  name = name.toUpperCase();

  for (const entry of warehouseMap) {
    if (entry.names.some(n => name.includes(n)) &&
        entry.keywords.some(k => name.includes(k))) {
      return entry.region;
    }
  }
  return 'Unknown';
}

function normalizeCarrier(value) {
  value = value?.toUpperCase() || '';
  if (value.includes('FEDEX')) return 'FEDEX';
  if (value.includes('UPS')) return 'UPS';
  if (value.includes('USPS')) return 'USPS';
  if (value.includes('ONTRAC')) return 'ONTRAC';
  if (value.includes('AMAZON')) return 'Amazon Logistics';
  return 'Other';
}

function processData(data) {
  if (data.length === 0) return;

  // Find most recent date in the file
  const dateCounts = {};
  data.forEach(row => {
    const d = row['Order Date']?.trim();
    if (d) {
      dateCounts[d] = (dateCounts[d] || 0) + 1;
    }
  });
  const mostRecentDate = Object.entries(dateCounts).sort((a,b) => b[1] - a[1])[0]?.[0];

  document.getElementById('reportDate').innerText = mostRecentDate;
  document.getElementById('dateHeader').classList.remove('hidden');

  const counts = {};

  data.forEach(row => {
    if (row['Order Date']?.trim() !== mostRecentDate) return;

    const warehouse = mapWarehouse(row['Ship From']);
    const carrier = normalizeCarrier(row['Carrier']);

    if (!counts[warehouse]) {
      counts[warehouse] = { total: 0 };
      carriers.forEach(c => counts[warehouse][c] = 0);
    }

    if (carriers.includes(carrier)) {
      counts[warehouse][carrier]++;
    }

    counts[warehouse].total++;
  });

  renderTable(counts);
}

function renderTable(data) {
  const table = document.getElementById('carrierTable');
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = '';

  Object.entries(data).forEach(([warehouse, count]) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${warehouse}</td>
      ${carriers.map(c => `<td>${count[c]}</td>`).join('')}
      <td>${count.total}</td>
    `;
    tbody.appendChild(row);
  });

  table.classList.remove('hidden');
}

function sortTable(n) {
  const table = document.getElementById("carrierTable");
  let switching = true, dir = "asc", switchcount = 0;

  while (switching) {
    switching = false;
    const rows = table.rows;

    for (let i = 1; i < rows.length - 1; i++) {
      let shouldSwitch = false;
      const x = rows[i].getElementsByTagName("TD")[n];
      const y = rows[i + 1].getElementsByTagName("TD")[n];

      const xVal = isNaN(x.innerHTML) ? x.innerHTML.toLowerCase() : parseInt(x.innerHTML);
      const yVal = isNaN(y.innerHTML) ? y.innerHTML.toLowerCase() : parseInt(y.innerHTML);

      if ((dir === "asc" && xVal > yVal) || (dir === "desc" && xVal < yVal)) {
        shouldSwitch = true;
        break;
      }
    }

    if (shouldSwitch) {
      rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
      switching = true;
      switchcount++;
    } else if (switchcount === 0 && dir === "asc") {
      dir = "desc";
      switching = true;
    }
  }
}
</script>

</body>
</html>
